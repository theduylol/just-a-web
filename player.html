<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PX Sender</title>
</head>
<body style="background:black; color:white; text-align:center; margin-top:100px;">

<button id="startBtn" style="padding:15px 30px; font-size:18px;">
    Start Canvas Menu
</button>

<script>
document.getElementById("startBtn").onclick = function(){

    // Just connect. No checks. No waiting.
    window.ws = new WebSocket("ws://seq.wtf/px");

    const GRID = 128;

    const palette = [
        [255,255,255],[194,194,194],[133,133,133],[0,0,0],
        [255,56,56],[255,150,94],[255,221,94],[104,210,91],
        [69,177,255],[61,106,255],[122,82,255],[255,85,255],
        [160,82,45],[222,184,135],[46,139,87],[128,0,128]
    ];

    function sendPixels(pixels){
        const buffer = new ArrayBuffer(2 + pixels.length * 3);
        const view = new DataView(buffer);
        view.setUint16(0, pixels.length, true);
        let o = 2;
        pixels.forEach(p=>{
            view.setUint8(o++, p.x);
            view.setUint8(o++, p.y);
            view.setUint8(o++, p.c);
        });
        window.ws.send(buffer);
    }

    function fullColor(index){
        const pixels=[];
        for(let y=0;y<GRID;y++){
            for(let x=0;x<GRID;x++){
                pixels.push({x,y,c:index});
            }
        }
        sendPixels(pixels);
    }

    function closest(r,g,b){
        let best=0, bestDist=Infinity;
        palette.forEach((p,i)=>{
            const dr=r-p[0], dg=g-p[1], db=b-p[2];
            const d=dr*dr+dg*dg+db*db;
            if(d<bestDist){bestDist=d;best=i;}
        });
        return best;
    }

    function uploadImage(){
        return new Promise(resolve=>{
            const input=document.createElement("input");
            input.type="file";
            input.accept="image/*";
            input.onchange=e=>{
                const file=e.target.files[0];
                const img=new Image();
                img.onload=()=>{
                    const canvas=document.createElement("canvas");
                    const ctx=canvas.getContext("2d");
                    canvas.width=GRID;
                    canvas.height=GRID;
                    ctx.drawImage(img,0,0,GRID,GRID);
                    const data=ctx.getImageData(0,0,GRID,GRID).data;

                    const pixels=[];
                    for(let y=0;y<GRID;y++){
                        for(let x=0;x<GRID;x++){
                            const i=(y*GRID+x)*4;
                            pixels.push({
                                x,y,
                                c:closest(data[i],data[i+1],data[i+2])
                            });
                        }
                    }

                    sendPixels(pixels);
                    resolve();
                };
                img.src=URL.createObjectURL(file);
            };
            input.click();
        });
    }

    function uploadVideo(){
        return new Promise(resolve=>{
            const input=document.createElement("input");
            input.type="file";
            input.accept="video/*";
            input.onchange=e=>{
                const file=e.target.files[0];
                const video=document.createElement("video");
                video.src=URL.createObjectURL(file);
                video.play();

                const canvas=document.createElement("canvas");
                const ctx=canvas.getContext("2d");
                canvas.width=GRID;
                canvas.height=GRID;

                function frame(){
                    if(video.paused||video.ended){
                        resolve();
                        return;
                    }
                    ctx.drawImage(video,0,0,GRID,GRID);
                    const data=ctx.getImageData(0,0,GRID,GRID).data;

                    const pixels=[];
                    for(let y=0;y<GRID;y++){
                        for(let x=0;x<GRID;x++){
                            const i=(y*GRID+x)*4;
                            pixels.push({
                                x,y,
                                c:closest(data[i],data[i+1],data[i+2])
                            });
                        }
                    }

                    sendPixels(pixels);
                    requestAnimationFrame(frame);
                }

                video.onplay=frame;
            };
            input.click();
        });
    }

    async function menu(){
        while(true){
            const choice = prompt(
`==== JS Canvas Menu ====
1. Full Black
2. Full White (Flashbang)
3. Upload Image
4. Upload Video
0. Exit`
            );

            if(choice==="1") fullColor(3);
            else if(choice==="2") fullColor(0);
            else if(choice==="3") await uploadImage();
            else if(choice==="4") await uploadVideo();
            else if(choice==="0" || choice===null) break;
        }
    }

    menu();
};
</script>

</body>
</html>

